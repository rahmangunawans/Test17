{% extends "responsive_base.html" %}

{% block title %}{{ episode.title }} - {{ content.title }}{% endblock %}

{% block head %}
<!-- HLS.js for M3U8 support -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.15/dist/hls.min.js"></script>

<style>
.video-container {
    position: relative;
    width: 100%;
    background: #1e293b;
    border-radius: 8px;
    overflow: hidden;
    aspect-ratio: 16/9;
}

#video-player {
    width: 100%;
    height: 100%;
    border-radius: 8px;
    background: #000000;
    display: block !important;
    min-height: 400px;
}

.glass-card {
    background: rgba(15, 23, 42, 0.8);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.content-bg {
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
}

.server-btn {
    transition: all 0.2s ease;
}

.server-btn:hover {
    transform: translateY(-1px);
}
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen content-bg pt-32 pb-8">
    <div class="container mx-auto px-4">
        <!-- Back Button -->
        <div class="mb-6">
            <a href="{{ url_for('content.anime_list') }}" 
               class="inline-flex items-center px-4 py-2 rounded-xl bg-slate-800/50 hover:bg-slate-700/50 border border-slate-600/30 text-slate-300 hover:text-white transition-all duration-200 backdrop-blur-sm">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Back to Anime List
            </a>
        </div>

        <!-- Server Selection -->
        <div class="glass-card rounded-2xl p-4 mb-6">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-semibold text-white flex items-center">
                    <i class="fas fa-server mr-2 text-red-500"></i>
                    Select Server
                </h3>
                <div class="text-sm text-slate-400">
                    Choose your preferred streaming source
                </div>
            </div>
            
            <div class="flex flex-wrap gap-3">
                {% if episode.server_m3u8_url %}
                <button onclick="switchServer('m3u8', '{{ episode.server_m3u8_url }}')" 
                        id="server-m3u8"
                        class="server-btn flex items-center px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white font-medium transition-all duration-200">
                    <i class="fas fa-play-circle mr-2"></i>
                    Server 1 (M3U8)
                </button>
                {% endif %}
                
                {% if episode.server_embed_url %}
                <button onclick="switchServer('embed', '{{ episode.server_embed_url }}')" 
                        id="server-embed"
                        class="server-btn flex items-center px-4 py-2 rounded-lg bg-slate-600 hover:bg-slate-700 text-white font-medium transition-all duration-200">
                    <i class="fas fa-code mr-2"></i>
                    Server 2 (Embed)
                </button>
                {% endif %}
                
                {% if episode.iqiyi_play_url %}
                <button onclick="switchServer('iqiyi', '{{ episode.iqiyi_play_url }}')" 
                        id="server-iqiyi"
                        class="server-btn flex items-center px-4 py-2 rounded-lg bg-orange-600 hover:bg-orange-700 text-white font-medium transition-all duration-200">
                    <i class="fas fa-tachometer-alt mr-2"></i>
                    Server 3 (iQiyi)
                </button>
                {% endif %}
                
                {% if episode.video_url %}
                <button onclick="switchServer('direct', '{{ episode.video_url }}')" 
                        id="server-direct"
                        class="server-btn flex items-center px-4 py-2 rounded-lg bg-slate-600 hover:bg-slate-700 text-white font-medium transition-all duration-200">
                    <i class="fas fa-video mr-2"></i>
                    Direct Video
                </button>
                {% endif %}
            </div>
        </div>

        <!-- Video Player -->
        <div class="glass-card rounded-2xl p-4 mb-6">
            <div class="video-container">
                <video 
                    id="video-player" 
                    class="w-full h-full" 
                    controls 
                    crossorigin 
                    playsinline
                    preload="metadata"
                    poster="{{ episode.thumbnail_url or content.thumbnail_url or '/static/images/default-poster.jpg' }}">
                    
                    <!-- Default M3U8 source -->
                    {% if episode.server_m3u8_url %}
                    <source type="application/x-mpegURL" src="{{ episode.server_m3u8_url }}">
                    {% endif %}
                    
                    <p class="text-white p-4">Your browser does not support the video tag.</p>
                </video>

                <!-- Time Limit Overlay for Free Users -->
                {% if not can_watch_full and max_watch_time %}
                <div id="upgrade-overlay" class="absolute inset-0 flex items-center justify-center z-50 bg-black/80 hidden">
                    <div class="text-center text-white p-8">
                        <h3 class="text-3xl font-bold mb-2">Preview Time Expired</h3>
                        <p class="text-xl text-gray-200 mb-6">Upgrade to VIP to watch full episodes</p>
                        <div class="space-y-4">
                            <a href="{{ url_for('subscription.subscription_page') }}" 
                               class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-red-500 to-purple-600 hover:from-red-600 hover:to-purple-700 rounded-xl font-bold text-lg transition-all duration-200 transform hover:scale-105">
                                Upgrade to VIP
                            </a>
                            <button onclick="restartVideo()" 
                                    class="block w-full px-6 py-3 border border-white/30 rounded-xl hover:bg-white/10 transition-all duration-200">
                                Watch Preview Again
                            </button>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Episode Information -->
        <div class="glass-card rounded-2xl p-6">
            <h1 class="text-2xl font-bold text-white mb-2">{{ episode.title }}</h1>
            <h2 class="text-lg text-slate-300 mb-4">{{ content.title }} - Episode {{ episode.episode_number }}</h2>
            
            {% if content.description %}
            <div class="mt-4">
                <h5 class="text-sm font-semibold text-slate-300 mb-3">Synopsis</h5>
                <p class="text-slate-400 leading-relaxed">{{ content.description }}</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
console.log('Simple video player initializing...');

// Global HLS player instance
let hlsPlayer = null;

// Initialize video player
document.addEventListener('DOMContentLoaded', function() {
    const videoPlayer = document.getElementById('video-player');
    if (!videoPlayer) {
        console.error('Video player element not found');
        return;
    }

    console.log('Video player element found:', videoPlayer);

    // Force video to be visible
    videoPlayer.style.display = 'block';
    videoPlayer.style.background = '#000000';
    videoPlayer.style.minHeight = '400px';

    // Add comprehensive error handling
    videoPlayer.addEventListener('error', function(e) {
        console.error('Video error event:', e);
        if (videoPlayer.error) {
            console.error('Video error code:', videoPlayer.error.code);
            console.error('Video error message:', videoPlayer.error.message);
        }
    });

    videoPlayer.addEventListener('loadstart', function() {
        console.log('Video load started');
    });

    videoPlayer.addEventListener('loadedmetadata', function() {
        console.log('Video metadata loaded');
    });

    videoPlayer.addEventListener('canplay', function() {
        console.log('Video can start playing');
    });

    videoPlayer.addEventListener('playing', function() {
        console.log('Video is now playing');
    });

    // Initialize HLS for M3U8 streams if available
    {% if episode.server_m3u8_url %}
    const m3u8Url = '{{ episode.server_m3u8_url }}';
    console.log('M3U8 URL found:', m3u8Url);
    
    // Initialize M3U8 playback
    initializeM3U8(m3u8Url);
    {% else %}
    console.log('No M3U8 URL found for this episode');
    {% endif %}

    // Watch time restriction for free users
    {% if not can_watch_full and max_watch_time %}
    let watchTimer;
    const maxWatchSeconds = {{ max_watch_time }} * 60;
    
    videoPlayer.addEventListener('play', function() {
        if (watchTimer) clearTimeout(watchTimer);
        watchTimer = setTimeout(function() {
            videoPlayer.pause();
            document.getElementById('upgrade-overlay').classList.remove('hidden');
        }, maxWatchSeconds * 1000);
    });
    
    videoPlayer.addEventListener('pause', function() {
        if (watchTimer) clearTimeout(watchTimer);
    });
    {% endif %}
});

// Initialize M3U8 playback function
function initializeM3U8(url) {
    const videoPlayer = document.getElementById('video-player');
    
    if (typeof Hls !== 'undefined' && Hls.isSupported()) {
        console.log('HLS.js is supported, initializing...');
        
        // Destroy existing HLS instance if any
        if (hlsPlayer) {
            hlsPlayer.destroy();
        }
        
        hlsPlayer = new Hls({
            debug: true,
            enableWorker: true,
            lowLatencyMode: false,
            manifestLoadingTimeOut: 10000,
            manifestLoadingMaxRetry: 4,
            levelLoadingTimeOut: 10000,
            levelLoadingMaxRetry: 4,
            fragLoadingTimeOut: 20000,
            fragLoadingMaxRetry: 6
        });
        
        hlsPlayer.loadSource(url);
        hlsPlayer.attachMedia(videoPlayer);
        
        hlsPlayer.on(Hls.Events.MANIFEST_PARSED, function() {
            console.log('HLS manifest parsed successfully');
            videoPlayer.style.display = 'block';
        });
        
        hlsPlayer.on(Hls.Events.ERROR, function(event, data) {
            console.error('HLS Error:', data);
            if (data.fatal) {
                console.log('Fatal HLS error, trying direct video src fallback');
                videoPlayer.src = url;
            }
        });
        
    } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
        console.log('Using Safari native HLS support');
        videoPlayer.src = url;
    } else {
        console.log('HLS not supported, trying direct playback');
        videoPlayer.src = url;
    }
}

// Server switching function
function switchServer(serverType, serverUrl) {
    console.log('Switching to server:', serverType, 'URL:', serverUrl);
    
    const videoPlayer = document.getElementById('video-player');
    const videoContainer = videoPlayer.parentElement;
    
    // Clear all server button active states
    document.querySelectorAll('.server-btn').forEach(btn => {
        btn.classList.remove('bg-green-600', 'bg-orange-600');
        btn.classList.add('bg-slate-600');
    });
    
    // Set active server button
    const activeBtn = document.getElementById('server-' + serverType);
    if (activeBtn) {
        activeBtn.classList.remove('bg-slate-600');
        if (serverType === 'm3u8') {
            activeBtn.classList.add('bg-green-600');
        } else if (serverType === 'iqiyi') {
            activeBtn.classList.add('bg-orange-600');
        }
    }
    
    if (serverType === 'embed') {
        // Replace video with iframe for embed
        videoContainer.innerHTML = `
            <iframe 
                src="${serverUrl}" 
                class="w-full h-full rounded-lg" 
                frameborder="0" 
                allowfullscreen>
            </iframe>
        `;
    } else {
        // Restore video element if iframe was used
        if (videoContainer.querySelector('iframe')) {
            videoContainer.innerHTML = `
                <video 
                    id="video-player" 
                    class="w-full h-full" 
                    controls 
                    crossorigin 
                    playsinline
                    preload="metadata"
                    style="display: block; background: #000; min-height: 400px;">
                </video>
            `;
        }
        
        const newVideoPlayer = document.getElementById('video-player');
        
        if (serverType === 'm3u8') {
            // Use M3U8 initialization
            initializeM3U8(serverUrl);
        } else {
            // Direct video playback
            if (hlsPlayer) {
                hlsPlayer.destroy();
                hlsPlayer = null;
            }
            newVideoPlayer.src = serverUrl;
        }
    }
}

// Restart video function for free users
function restartVideo() {
    const videoPlayer = document.getElementById('video-player');
    if (videoPlayer) {
        videoPlayer.currentTime = 0;
        videoPlayer.play();
        document.getElementById('upgrade-overlay').classList.add('hidden');
    }
}
</script>
{% endblock %}