{% extends "responsive_base.html" %}

{% block title %}{{ episode.title }} - {{ content.title }}{% endblock %}

{% block head %}
<!-- Plyr.io CSS -->
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

<style>
.video-container {
    position: relative;
    width: 100%;
    background: #1e293b;
    border-radius: 8px;
    overflow: hidden;
    aspect-ratio: 16/9;
}

#video-player {
    width: 100%;
    height: 100%;
    border-radius: 8px;
    background: #000000;
    display: block !important;
    min-height: 400px;
}

/* Plyr.io custom styling to match AniFlix theme */
.plyr {
    border-radius: 8px;
}

.plyr--video {
    background: #000000;
}

.plyr__control--overlaid {
    background: rgba(239, 68, 68, 0.9);
}

.plyr__control--overlaid:hover {
    background: rgba(239, 68, 68, 1);
}

.plyr__controls {
    background: linear-gradient(180deg, transparent 0%, rgba(0, 0, 0, 0.8) 100%);
}

.plyr__control.plyr__tab-focus,
.plyr__control:hover,
.plyr__control[aria-expanded=true] {
    background: rgba(239, 68, 68, 0.8);
}

.plyr__progress__played {
    background: #ef4444;
}

.plyr__volume__progress {
    background: #ef4444;
}

.plyr__menu__container .plyr__control:hover {
    background: rgba(239, 68, 68, 0.1);
}

.glass-card {
    background: rgba(15, 23, 42, 0.8);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.content-bg {
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
}

.server-btn {
    transition: all 0.2s ease;
}

.server-btn:hover {
    transform: translateY(-1px);
}
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen content-bg pt-32 pb-8">
    <div class="container mx-auto px-4">
        <!-- Back Button -->
        <div class="mb-6">
            <a href="{{ url_for('content.anime_list') }}" 
               class="inline-flex items-center px-4 py-2 rounded-xl bg-slate-800/50 hover:bg-slate-700/50 border border-slate-600/30 text-slate-300 hover:text-white transition-all duration-200 backdrop-blur-sm">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Back to Anime List
            </a>
        </div>

        <!-- Server Selection -->
        <div class="glass-card rounded-2xl p-4 mb-6">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-semibold text-white flex items-center">
                    <i class="fas fa-server mr-2 text-red-500"></i>
                    Select Server
                </h3>
                <div class="text-sm text-slate-400">
                    Choose your preferred streaming source
                </div>
            </div>
            
            <div class="flex flex-wrap gap-3">
                {% if episode.server_m3u8_url %}
                <button onclick="switchServer('m3u8', '{{ episode.server_m3u8_url }}')" 
                        id="server-m3u8"
                        class="server-btn flex items-center px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white font-medium transition-all duration-200">
                    <i class="fas fa-play-circle mr-2"></i>
                    Server 1 (M3U8)
                </button>
                {% endif %}
                
                {% if episode.server_embed_url %}
                <button onclick="switchServer('embed', '{{ episode.server_embed_url }}')" 
                        id="server-embed"
                        class="server-btn flex items-center px-4 py-2 rounded-lg bg-slate-600 hover:bg-slate-700 text-white font-medium transition-all duration-200">
                    <i class="fas fa-code mr-2"></i>
                    Server 2 (Embed)
                </button>
                {% endif %}
                
                {% if episode.iqiyi_play_url %}
                <button onclick="switchServer('iqiyi', '{{ episode.iqiyi_play_url }}')" 
                        id="server-iqiyi"
                        class="server-btn flex items-center px-4 py-2 rounded-lg bg-orange-600 hover:bg-orange-700 text-white font-medium transition-all duration-200">
                    <i class="fas fa-tachometer-alt mr-2"></i>
                    Server 3 (iQiyi)
                </button>
                {% endif %}
                
                {% if episode.video_url %}
                <button onclick="switchServer('direct', '{{ episode.video_url }}')" 
                        id="server-direct"
                        class="server-btn flex items-center px-4 py-2 rounded-lg bg-slate-600 hover:bg-slate-700 text-white font-medium transition-all duration-200">
                    <i class="fas fa-video mr-2"></i>
                    Direct Video
                </button>
                {% endif %}
            </div>
        </div>

        <!-- Video Player -->
        <div class="glass-card rounded-2xl p-4 mb-6">
            <div class="video-container" style="position: relative; width: 100%; min-height: 400px; background: #000;">
                <video 
                    id="video-player" 
                    class="w-full h-full" 
                    style="display: block; background: #000; min-height: 400px;" 
                    controls 
                    crossorigin 
                    playsinline
                    preload="metadata"
                    poster="{{ episode.thumbnail_url or content.thumbnail_url or '/static/images/default-poster.jpg' }}">
                    
                    <!-- Default M3U8 source -->
                    {% if episode.server_m3u8_url %}
                    <source type="application/x-mpegURL" src="{{ episode.server_m3u8_url }}">
                    {% endif %}
                    
                    <p class="text-white p-4">Your browser does not support the video tag.</p>
                </video>

                <!-- VIP Download Menu (Only show if user has VIP) -->
                {% if current_user.is_authenticated and current_user.is_vip() %}
                <div class="absolute top-4 right-4">
                    <div class="relative">
                        <button onclick="toggleDownloadMenu()" 
                                class="pointer-events-auto bg-red-500/80 hover:bg-red-500/90 backdrop-blur-sm rounded-lg px-4 py-2 text-white text-sm border border-red-500/40 hover:border-red-500/60 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-red-500/50 flex items-center">
                            <i class="fas fa-download mr-2"></i>
                            Download (VIP)
                        </button>
                    </div>
                </div>
                {% endif %}

                <!-- Time Limit Overlay for Free Users -->
                {% if not can_watch_full and max_watch_time %}
                <div id="upgrade-overlay" class="absolute inset-0 flex items-center justify-center z-50 bg-black/80 hidden">
                    <div class="text-center text-white p-8">
                        <h3 class="text-3xl font-bold mb-2">Preview Time Expired</h3>
                        <p class="text-xl text-gray-200 mb-6">Upgrade to VIP to watch full episodes</p>
                        <div class="space-y-4">
                            <a href="{{ url_for('subscription.subscription_page') }}" 
                               class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-red-500 to-purple-600 hover:from-red-600 hover:to-purple-700 rounded-xl font-bold text-lg transition-all duration-200 transform hover:scale-105">
                                Upgrade to VIP
                            </a>
                            <button onclick="restartVideo()" 
                                    class="block w-full px-6 py-3 border border-white/30 rounded-xl hover:bg-white/10 transition-all duration-200">
                                Watch Preview Again
                            </button>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Episode Information -->
        <div class="glass-card rounded-2xl p-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left Column - Main Info -->
                <div class="lg:col-span-2 space-y-4">
                    <!-- Title Section -->
                    <div>
                        <h1 class="text-2xl font-bold text-white mb-2">{{ episode.title }}</h1>
                        <h2 class="text-lg text-slate-300 mb-4">{{ content.title }} - Episode {{ episode.episode_number }}</h2>
                        
                        <!-- Meta Information -->
                        <div class="flex flex-wrap items-center gap-4 text-sm text-slate-400 mb-4">
                            {% if content.year %}
                            <span class="flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                {{ content.year }}
                            </span>
                            {% endif %}
                            {% if content.rating %}
                            <span class="flex items-center gap-1">
                                <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                </svg>
                                {{ "%.1f"|format(content.rating) }}/10
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if content.genre %}
                    <div>
                        <h5 class="text-sm font-semibold text-slate-300 mb-2">Genre</h5>
                        <div class="flex flex-wrap gap-2">
                            {% for genre in content.genre.split(',') %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-500/20 text-purple-400 border border-purple-500/30">
                                {{ genre.strip() }}
                            </span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Right Column - Stats & Actions -->
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-600/30 text-center">
                            <div class="text-xl font-bold text-red-400 mb-1">{{ content.episodes|length }}</div>
                            <div class="text-xs text-slate-400">Episodes</div>
                        </div>
                        <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-600/30 text-center">
                            <div class="text-xl font-bold text-blue-400 mb-1">{{ content.content_type.title() }}</div>
                            <div class="text-xs text-slate-400">Type</div>
                        </div>
                    </div>
                    
                    <!-- Episode Progress -->
                    <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-600/30">
                        <h5 class="text-sm font-semibold text-slate-300 mb-3">Progress</h5>
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-slate-400">Ep {{ episode.episode_number }} / {{ content.total_episodes or content.episodes|length }}</span>
                                <span class="text-slate-300">{{ progress_percentage }}%</span>
                            </div>
                            <div class="w-full bg-slate-700 rounded-full h-2">
                                <div class="bg-gradient-to-r from-red-500 to-purple-600 h-2 rounded-full transition-all duration-300" style="width: {{ progress_percentage }}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Description -->
            {% if content.description %}
            <div class="mt-6">
                <h5 class="text-sm font-semibold text-slate-300 mb-3">Synopsis</h5>
                <p class="text-slate-400 leading-relaxed">{{ content.description }}</p>
            </div>
            {% endif %}
        </div>

        <!-- Episodes List -->
        <div class="glass-card rounded-2xl p-6">
            <h3 class="text-xl font-bold text-white mb-6 flex items-center">
                <svg class="w-6 h-6 mr-3 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                </svg>
                Episodes ({{ content.episodes|length }})
            </h3>
            
            <div class="episode-grid flex gap-4 overflow-x-auto pb-4 scroll-smooth">
                {% for ep in content.episodes %}
                <div class="flex-shrink-0 w-64">
                    <div class="episode-card bg-slate-800/50 hover:bg-slate-700/50 rounded-xl overflow-hidden border border-slate-600/30 {% if ep.id == episode.id %}ring-2 ring-red-500{% endif %}">
                        <div class="aspect-video relative bg-gradient-to-br from-slate-700 to-slate-800">
                            <img src="{{ content.thumbnail_url }}" alt="Episode {{ ep.episode_number }}" 
                                 class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity duration-200">
                                {% if ep.id != episode.id %}
                                <a href="{{ url_for('content.watch_episode', episode_id=ep.id) }}" 
                                   class="inline-flex items-center justify-center w-12 h-12 bg-red-500 hover:bg-red-600 rounded-full text-white transition-colors duration-200">
                                    <svg class="w-6 h-6 ml-1" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M8 5v14l11-7z"/>
                                    </svg>
                                </a>
                                {% else %}
                                <div class="inline-flex items-center justify-center w-12 h-12 bg-red-500 rounded-full text-white">
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M8 5v14l11-7z"/>
                                    </svg>
                                </div>
                                {% endif %}
                            </div>
                            {% if ep.id == episode.id %}
                            <div class="absolute top-2 right-2">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-500 text-white">
                                    Now Playing
                                </span>
                            </div>
                            {% endif %}
                        </div>
                        <div class="p-4">
                            <h4 class="font-semibold text-white text-sm mb-1">Episode {{ ep.episode_number }}</h4>
                            <p class="text-slate-400 text-xs line-clamp-2">{{ ep.title }}</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="xl:col-span-1 space-y-6">
        <!-- Continue Watching -->
        {% if recent_episodes %}
        <div class="glass-card rounded-2xl p-6">
            <h3 class="text-lg font-bold text-white mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2M7 4h10M7 4a1 1 0 00-1 1v8M6 5v8a1 1 0 001 1h8a1 1 0 001-1V5m-4 3v4"></path>
                </svg>
                Continue Watching
            </h3>
            <div class="space-y-3">
                {% for recent in recent_episodes[:3] %}
                <a href="{{ url_for('content.watch_episode', episode_id=recent.episode.id) }}" 
                   class="block p-3 rounded-xl bg-slate-800/30 hover:bg-slate-700/40 border border-slate-600/20 hover:border-slate-500/30 transition-all duration-200">
                    <div class="flex items-center space-x-3">
                        <img src="{{ recent.content.thumbnail_url }}" alt="{{ recent.content.title }}" 
                             class="w-12 h-16 object-cover rounded-lg flex-shrink-0">
                        <div class="flex-1 min-w-0">
                            <h4 class="font-medium text-white text-sm truncate">{{ recent.content.title }}</h4>
                            <p class="text-xs text-slate-400 mt-1">Episode {{ recent.episode.episode_number }}</p>
                            <div class="w-full bg-slate-700 rounded-full h-1 mt-2">
                                <div class="bg-red-500 h-1 rounded-full" style="width: {{ (recent.watch_time / 1800 * 100) if recent.watch_time else 0 }}%"></div>
                            </div>
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Trending Anime -->
        {% if trending_anime %}
        <div class="glass-card rounded-2xl p-6">
            <h3 class="text-lg font-bold text-white mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                </svg>
                Trending Now
            </h3>
            <div class="space-y-3 max-h-80 overflow-y-auto">
                {% for anime in trending_anime[:5] %}
                <a href="{{ url_for('content.content_detail', content_id=anime.id) }}" 
                   class="block p-3 rounded-xl bg-slate-800/30 hover:bg-slate-700/40 border border-slate-600/20 hover:border-slate-500/30 transition-all duration-200">
                    <div class="flex items-center space-x-3">
                        <img src="{{ anime.thumbnail_url }}" alt="{{ anime.title }}" 
                             class="w-12 h-16 object-cover rounded-lg flex-shrink-0">
                        <div class="flex-1 min-w-0">
                            <h4 class="font-medium text-white text-sm truncate">{{ anime.title }}</h4>
                            <p class="text-xs text-slate-400 mt-1">{{ anime.content_type.title() }}</p>
                            {% if anime.rating %}
                            <div class="flex items-center mt-1">
                                <svg class="w-3 h-3 text-yellow-400 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                </svg>
                                <span class="text-xs text-slate-400">{{ "%.1f"|format(anime.rating) }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
</div>

<script>
console.log('🎬 AniFlix Plyr.io Video Player Starting...');
console.log('📺 Video element check:', document.getElementById('video-player'));
console.log('📦 Plyr available:', typeof Plyr !== 'undefined');
console.log('📦 HLS available:', typeof Hls !== 'undefined');

// Global variables  
let player = null;
let hls = null;

// Initialize player based on working test.html pattern
function initializePlayer(source) {
    const video = document.getElementById('video-player');
    
    if (!video) {
        console.error('❌ Video element not found');
        return;
    }
    
    // Clean up existing player and HLS
    if (player) {
        player.destroy();
        player = null;
    }
    if (hls) {
        hls.destroy();
        hls = null;
    }
    
    // Clear video source completely
    video.src = '';
    video.load();
    
    console.log('🎬 Initializing player with source:', source);
    
    if (source && typeof Hls !== 'undefined' && Hls.isSupported()) {
        // Use HLS.js for M3U8 sources
        hls = new Hls({
            debug: false,
            enableWorker: true,
            lowLatencyMode: true,
        });
        
        hls.loadSource(source);
        hls.attachMedia(video);
        
        hls.on(Hls.Events.MANIFEST_PARSED, function() {
            console.log('✅ HLS manifest parsed successfully');
            
            // Initialize Plyr after HLS is ready
            player = new Plyr(video, {
                captions: { active: true, update: true, language: 'en' },
                controls: [
                    'play-large', 'play', 'progress', 'current-time', 'duration', 
                    'mute', 'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'
                ],
                settings: ['captions', 'quality', 'speed'],
                quality: { default: 720, options: [4320, 2880, 2160, 1440, 1080, 720, 576, 480, 360, 240] },
                speed: { selected: 1, options: [0.5, 0.75, 1, 1.25, 1.5, 2] }
            });
            
            // Global access
            window.player = player;
            window.hls = hls;
            
            console.log('✅ Plyr + HLS.js initialized successfully');
            
            // Watch time restriction for free users
            {% if not can_watch_full and max_watch_time %}
            const maxWatchSeconds = {{ max_watch_time|int }} * 60;
            player.on('play', function() {
                setTimeout(function() {
                    player.pause();
                    document.getElementById('upgrade-overlay').classList.remove('hidden');
                }, maxWatchSeconds * 1000);
            });
            {% endif %}
        });
        
        hls.on(Hls.Events.ERROR, function(event, data) {
            console.error('❌ HLS Error:', data);
            console.error('❌ Error details:', {
                type: data.type,
                details: data.details,
                fatal: data.fatal,
                url: data.url,
                response: data.response
            });
            
            if (data.fatal) {
                switch(data.type) {
                    case Hls.ErrorTypes.NETWORK_ERROR:
                        console.log('🔄 Trying to recover network error');
                        hls.startLoad();
                        break;
                    case Hls.ErrorTypes.MEDIA_ERROR:
                        console.log('🔄 Trying to recover media error'); 
                        hls.recoverMediaError();
                        break;
                    default:
                        hls.destroy();
                        console.log('💥 Fatal error, cannot recover');
                        break;
                }
            }
        });
        
    } else if (source && video.canPlayType('application/vnd.apple.mpegurl')) {
        // Safari native HLS support
        video.src = source;
        player = new Plyr(video, {
            captions: { active: true, update: true, language: 'en' },
            controls: [
                'play-large', 'play', 'progress', 'current-time', 'duration', 
                'mute', 'volume', 'settings', 'fullscreen'
            ]
        });
        window.player = player;
        console.log('✅ Native HLS player initialized');
        
    } else if (source) {
        // Direct video playback
        video.src = source;
        player = new Plyr(video);
        window.player = player;
        console.log('✅ Direct video player initialized');
        
    } else {
        // Initialize empty Plyr for manual loading
        player = new Plyr(video, {
            controls: [
                'play-large', 'play', 'progress', 'current-time', 'duration', 
                'mute', 'volume', 'settings', 'fullscreen'
            ]
        });
        window.player = player;
        console.log('✅ Empty Plyr player initialized');
    }
}

// Server switching function  
async function switchServer(serverType, serverUrl) {
    console.log('🔄 Switching to server:', serverType, serverUrl);
    
    // Force cleanup of existing player and HLS instances first
    if (window.player) {
        window.player.destroy();
        window.player = null;
    }
    if (window.hls) {
        window.hls.destroy();
        window.hls = null;
    }
    
    // Update active button
    document.querySelectorAll('.server-btn').forEach(btn => {
        btn.classList.remove('bg-green-600', 'bg-orange-600');
        btn.classList.add('bg-slate-600');
    });
    
    const activeBtn = document.getElementById('server-' + serverType);
    if (activeBtn) {
        activeBtn.classList.remove('bg-slate-600');
        if (serverType === 'm3u8') {
            activeBtn.classList.add('bg-green-600');
        } else if (serverType === 'iqiyi') {
            activeBtn.classList.add('bg-orange-600');
        }
    }
    
    if (serverType === 'embed') {
        // Handle embed URLs (like YouTube)
        const video = document.getElementById('video-player');
        const container = video.parentElement;
        
        container.innerHTML = `<iframe src="${serverUrl}" class="w-full h-full rounded-lg" frameborder="0" allowfullscreen></iframe>`;
        console.log('✅ Embed player loaded');
        
    } else if (serverType === 'direct') {
        // Handle direct video URLs
        const video = document.getElementById('video-player');
        
        // Restore video element if iframe was used
        if (!video) {
            const container = document.querySelector('.video-container');
            container.innerHTML = `
                <video 
                    id="video-player" 
                    class="w-full h-full" 
                    controls 
                    crossorigin 
                    playsinline
                    preload="metadata"
                    poster="{{ episode.thumbnail_url or content.thumbnail_url or '/static/images/default-poster.jpg' }}">
                    <p class="text-white p-4">Your browser does not support the video tag.</p>
                </video>
            `;
        }
        
        initializePlayer(serverUrl);
        
    } else {
        // Handle M3U8 and iQiyi URLs
        const video = document.getElementById('video-player');
        
        // Check if URL is an iQiyi play page (extract M3U8 with better video handling)
        if (serverUrl.includes('iq.com/play/') || serverUrl.includes('iqiyi.com/play/')) {
            console.log('🔄 Extracting M3U8 from iQiyi play URL...');
            
            try {
                const response = await fetch('/admin/api/extract-iqiyi-m3u8', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ iqiyi_play_url: serverUrl })
                });
                
                const result = await response.json();
                
                if (result.success && (result.m3u8_content || result.m3u8_url)) {
                    console.log('✅ iQiyi M3U8 extracted successfully');
                    
                    // Create new video element with maximum visibility enforcement
                    const container = document.querySelector('.video-container');
                    
                    // Clear container and force its styling too
                    container.style.cssText = `
                        width: 100% !important;
                        height: 100% !important;
                        display: block !important;
                        position: relative !important;
                        background: #000 !important;
                        min-height: 400px !important;
                    `;
                    
                    container.innerHTML = `
                        <video 
                            id="video-player" 
                            class="w-full h-full" 
                            controls 
                            crossorigin="anonymous"
                            playsinline
                            preload="metadata"
                            webkit-playsinline
                            muted
                            style="
                                width: 100% !important; 
                                height: 100% !important; 
                                display: block !important; 
                                background: #000 !important; 
                                object-fit: contain !important;
                                visibility: visible !important;
                                opacity: 1 !important;
                                z-index: 999 !important;
                                position: relative !important;
                                min-height: 400px !important;
                                max-width: none !important;
                            ">
                            <p class="text-white p-4">Your browser does not support the video tag.</p>
                        </video>
                    `;
                    
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    const video = document.getElementById('video-player');
                    
                    // Try direct M3U8 URL first, fallback to blob if needed
                    let videoUrl;
                    if (result.m3u8_url) {
                        videoUrl = result.m3u8_url;
                        console.log('🔗 Using direct M3U8 URL:', videoUrl);
                    } else {
                        const blob = new Blob([result.m3u8_content], { type: 'application/vnd.apple.mpegurl' });
                        videoUrl = URL.createObjectURL(blob);
                        console.log('🔗 Using blob URL:', videoUrl);
                    }
                    
                    if (video) {
                        console.log('🎬 Initializing iQiyi video with HLS');
                        console.log('📊 Video element state:', {
                            readyState: video.readyState,
                            networkState: video.networkState,
                            currentSrc: video.currentSrc,
                            videoWidth: video.videoWidth,
                            videoHeight: video.videoHeight,
                            paused: video.paused,
                            muted: video.muted
                        });
                        
                        // Force video properties with extreme visibility enforcement
                        video.style.cssText = `
                            display: block !important;
                            width: 100% !important;
                            height: 100% !important;
                            object-fit: contain !important;
                            background-color: #000 !important;
                            visibility: visible !important;
                            opacity: 1 !important;
                            z-index: 999 !important;
                            position: relative !important;
                            min-height: 400px !important;
                            border: 2px solid red !important;
                            transform: none !important;
                            overflow: visible !important;
                        `;
                        
                        // Remove any conflicting CSS classes
                        video.className = '';
                        video.classList.add('w-full', 'h-full');
                        video.muted = true; // Start muted to allow autoplay
                        
                        // Add comprehensive event listeners for debugging
                        video.addEventListener('loadstart', () => console.log('📺 Video: loadstart'));
                        video.addEventListener('loadedmetadata', () => {
                            console.log('📺 Video: loadedmetadata', {
                                duration: video.duration,
                                videoWidth: video.videoWidth,
                                videoHeight: video.videoHeight
                            });
                            
                            // Force video to be visible after metadata loads
                            if (video.videoWidth > 0 && video.videoHeight > 0) {
                                video.style.display = 'block';
                                video.style.visibility = 'visible';
                                video.style.opacity = '1';
                                console.log('🎬 Video dimensions confirmed, forcing visibility');
                            }
                        });
                        video.addEventListener('loadeddata', () => console.log('📺 Video: loadeddata'));
                        video.addEventListener('canplay', () => console.log('📺 Video: canplay'));
                        video.addEventListener('canplaythrough', () => console.log('📺 Video: canplaythrough'));
                        video.addEventListener('playing', () => console.log('📺 Video: playing'));
                        video.addEventListener('pause', () => console.log('📺 Video: pause'));
                        video.addEventListener('error', (e) => {
                            console.error('❌ Video error:', e, video.error);
                        });
                        
                        if (typeof Hls !== 'undefined' && Hls.isSupported()) {
                            const hlsInstance = new Hls({
                                debug: true,
                                enableWorker: true,
                                lowLatencyMode: false,
                                backBufferLength: 90,
                                maxBufferLength: 30,
                                maxMaxBufferLength: 300,
                                maxBufferSize: 60 * 1000 * 1000,
                                maxBufferHole: 0.5
                            });
                            
                            hlsInstance.loadSource(videoUrl);
                            hlsInstance.attachMedia(video);
                            
                            hlsInstance.on(Hls.Events.MANIFEST_PARSED, function() {
                                console.log('✅ iQiyi manifest parsed, starting playback test');
                                
                                // Test direct video playback first without Plyr
                                video.muted = false;
                                video.currentTime = 0;
                                
                                // Force play to test if video stream works
                                video.play().then(() => {
                                    console.log('✅ Direct video playback successful');
                                    
                                    // For iQiyi - DO NOT use Plyr, keep native HTML5 video
                                    console.log('🎬 Using native HTML5 video for iQiyi (no Plyr)');
                                    
                                    // Remove border now that we confirmed it works
                                    video.style.border = 'none';
                                    
                                    // Ensure video controls are visible
                                    video.controls = true;
                                    video.style.display = 'block';
                                    video.style.visibility = 'visible';
                                    video.style.opacity = '1';
                                    video.muted = false; // Unmute for user
                                    
                                    // Store references for global access
                                    window.player = video; // Use native video as player
                                    window.hls = hlsInstance;
                                    
                                    console.log('✅ iQiyi native video player ready (no Plyr wrapper)');
                                }).catch(error => {
                                    console.error('❌ Direct video playback failed:', error);
                                    
                                    // Try without HLS.js as fallback
                                    video.src = videoUrl;
                                    video.play().then(() => {
                                        console.log('✅ Fallback: Direct M3U8 playback works');
                                        video.controls = true;
                                        video.style.border = 'none';
                                        video.muted = false;
                                        window.player = video; // Native video, no Plyr
                                    }).catch(e => {
                                        console.error('❌ All playback methods failed:', e);
                                    });
                                });
                            });
                            
                            hlsInstance.on(Hls.Events.ERROR, function(event, data) {
                                console.error('❌ HLS Error:', data);
                                
                                if (data.fatal) {
                                    console.log('🔄 Fatal HLS error, trying direct M3U8');
                                    hlsInstance.destroy();
                                    
                                    // Fallback to direct M3U8 playback
                                    video.src = videoUrl;
                                    video.play().then(() => {
                                        console.log('✅ Fallback direct M3U8 works');
                                        video.controls = true;
                                        video.style.border = 'none';
                                        video.muted = false;
                                        window.player = video; // Native video, no Plyr
                                    }).catch(e => {
                                        console.error('❌ Complete playback failure:', e);
                                    });
                                }
                            });
                        } else {
                            // Safari/iOS fallback with native M3U8 support
                            console.log('🍎 Using Safari native M3U8 support');
                            video.src = videoUrl;
                            video.muted = false;
                            
                            video.addEventListener('loadedmetadata', () => {
                                console.log('✅ Safari M3U8 metadata loaded');
                                video.play().then(() => {
                                    console.log('✅ Safari M3U8 playback started');
                                    video.controls = true;
                                    video.style.border = 'none';
                                    video.muted = false;
                                    window.player = video; // Native video, no Plyr
                                }).catch(e => {
                                    console.error('❌ Safari playback failed:', e);
                                });
                            });
                            
                            video.addEventListener('error', (e) => {
                                console.error('❌ Safari video error:', e);
                            });
                        }
                    }
                } else {
                    throw new Error(result.error || 'Failed to extract M3U8');
                }
            } catch (error) {
                console.error('❌ iQiyi extraction failed:', error);
                // Fallback to iframe
                const container = document.querySelector('.video-container');
                container.innerHTML = `<iframe src="${serverUrl}" class="w-full h-full" frameborder="0" allowfullscreen></iframe>`;
            }
        } else {
            // Handle M3U8 URLs with Plyr
            // Restore video element if iframe was used
            if (!video || video.tagName !== 'VIDEO') {
                const container = document.querySelector('.video-container');
                container.innerHTML = `
                    <video 
                        id="video-player" 
                        class="w-full h-full" 
                        controls 
                        crossorigin 
                        playsinline
                        preload="metadata"
                        poster="{{ episode.thumbnail_url or content.thumbnail_url or '/static/images/default-poster.jpg' }}">
                        <p class="text-white p-4">Your browser does not support the video tag.</p>
                    </video>
                `;
                // Wait for DOM to update
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            initializePlayer(serverUrl);
        }
    }
}

// Restart video function for free users
function restartVideo() {
    if (player) {
        player.currentTime = 0;
        player.play();
        document.getElementById('upgrade-overlay').classList.add('hidden');
    }
}

// Download toggle function for VIP users
function toggleDownloadMenu() {
    console.log('Download menu toggled for VIP user');
    // Implement VIP download functionality
    alert('VIP Download Feature - Coming Soon!');
}

// Server 3 (iQiyi) handled via iframe - no extraction needed

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('✅ DOM loaded, checking for libraries...');
    
    if (typeof Plyr === 'undefined') {
        console.error('❌ Plyr library not loaded');
        return;
    }
    
    if (typeof Hls === 'undefined') {
        console.error('❌ HLS.js library not loaded');
        return;
    }
    
    console.log('✅ Libraries loaded, initializing...');
    
    // Initialize with default M3U8 source if available
    {% if episode.server_m3u8_url %}
    const defaultSource = '{{ episode.server_m3u8_url|e }}';
    console.log('🎬 Default M3U8 source found:', defaultSource);
    initializePlayer(defaultSource);
    {% else %}
    console.log('📺 No default source, initializing empty player');
    initializePlayer(null);
    {% endif %}
});
</script>
{% endblock %}